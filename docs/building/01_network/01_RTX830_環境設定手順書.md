# RTX830 環境設定手順書

## 1. 目次

<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 目次](#1-目次)
- [2. 目的・概要](#2-目的概要)
- [3. 前提条件](#3-前提条件)
- [4. 作業手順](#4-作業手順)
  - [4.1. 設定画面をブラウザで開く](#41-設定画面をブラウザで開く)
  - [4.2. WANの接続情報を設定する](#42-wanの接続情報を設定する)
  - [4.3. 機器のローカル IP アドレスを設定する](#43-機器のローカル-ip-アドレスを設定する)
  - [4.4. 使用しないポートを閉塞する](#44-使用しないポートを閉塞する)
  - [4.5. タグVLANを設定する](#45-タグvlanを設定する)
  - [4.6. VLAN間ルーティングを設定する](#46-vlan間ルーティングを設定する)
  - [4.7. VLAN間同士のIPフィルターを設定する](#47-vlan間同士のipフィルターを設定する)
  - [4.8. DHCPサーバの払い出しIP範囲を設定する](#48-dhcpサーバの払い出しip範囲を設定する)
    - [4.8.1. 追加したVLAN向けに設定する](#481-追加したvlan向けに設定する)
    - [4.8.2. 既存のVLAN1向けに設定する](#482-既存のvlan1向けに設定する)
  - [4.9. 日付と時刻を設定する](#49-日付と時刻を設定する)
  - [4.10. ブザー設定を無効化する](#410-ブザー設定を無効化する)
  - [4.11. アクセス等に必要なユーザとパスワードを設定する](#411-アクセス等に必要なユーザとパスワードを設定する)
    - [4.11.1. 管理パスワードを設定する](#4111-管理パスワードを設定する)
    - [4.11.2. 作業用ユーザを追加する](#4112-作業用ユーザを追加する)
  - [4.12. `ユーザー名なし`を実質的に無効化する](#412-ユーザー名なしを実質的に無効化する)
  - [4.13. SSH接続を設定する](#413-ssh接続を設定する)
    - [4.13.1. SSHサーバーを有効化する](#4131-sshサーバーを有効化する)
    - [4.13.2. 公開鍵認証に用いる公開鍵の情報を転送する](#4132-公開鍵認証に用いる公開鍵の情報を転送する)
    - [4.13.3. コンソールの文字コードを`UTF-8`に設定する](#4133-コンソールの文字コードをutf-8に設定する)
    - [4.13.4. telnetサーバを無効化する](#4134-telnetサーバを無効化する)
    - [4.13.5. telnetサーバへのアクセスを拒否する](#4135-telnetサーバへのアクセスを拒否する)
  - [4.14. Web GUIへのアクセスを制限する](#414-web-guiへのアクセスを制限する)
  - [4.15. L2MSを有効化する](#415-l2msを有効化する)
- [5. 完了条件](#5-完了条件)

<!-- /code_chunk_output -->

## 2. 目的・概要

おうちネットワークのルータとなる`RTX830`の環境設定を行う手順書です。

## 3. 前提条件

- `RTX830`が工場初期化状態になっていること
- `ONU`からのLANケーブルが`RTX830`のWANポートに接続されていること
- 作業端末が作業対象の`RTX830`にネットワーク越しに接続できること

## 4. 作業手順

### 4.1. 設定画面をブラウザで開く

- アドレス: <https://192.168.100.1/>
- ログイン情報:
  - ユーザ: 空欄
  - パスワード: 空欄

### 4.2. WANの接続情報を設定する

1. `詳細設定`タブを押下する
2. 左ペインの`プロバイダー接続`を押下する
3. `新規設定`メニューで以下を指定する

    - 接続種別: `PPPoE接続（WAN）`

4. `新規`を押下する
5. 以下を指定
    **基本設定**
    - 設定名: `Biglobe光(IPv4 PPPoE)`
    - ユーザーID: BIGLOBE会員証 > `インターネット接続の機器設定に必要な情報` > `ユーザー名`
    - 接続パスワード: BIGLOBE会員証 > `インターネット接続の機器設定に必要な情報` > `接続パスワード`
    - 認証方式: 以下にチェック
      - `PAP`
      - `CHAP`
    - 自動接続: `自動接続する`
    - 自動切断: `自動切断しない`
    - PP[01] の IPアドレス: `IPCP で取得する`
    - MTU の値: `自動`
    - キープアライブ
      - 送信間隔: `30秒`
      - 確認に失敗した後の再送間隔: `30秒`
      - 回線断と判断する基準
        - 連続失敗回数: `12回`

    **DNSサーバーの設定**
    - DNSサーバーアドレス: `プロバイダーから自動取得する`

    **静的ルーティングの設定**
    - 宛先ネットワーク: `デフォルト経路`

    **NATの設定**
    - NATの利用: `利用する`
    - 定義方法: `IPマスカレード`
    - 外側アドレス: `IPCPで取得したアドレス`
    - 内側アドレス: `すべてのアドレス`

    **IPフィルターの設定**
    - IPフィルター: `推奨のIPフィルターを設定する`

    **ポート開放の設定**
    - 本機の管理用ポートの開放: `チェックなし`
    - 転送用ポートの開放: `開放しない`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `設定の一覧` > `デフォルトゲートウェイに設定されているプロバイダー接続`に、`Biglobe光(IPv4 PPPoE)`が表示されていることを確認する
9. `接続状態` > `接続する`を押下する
10. `実行`を押下する
11. `接続状態`にグローバル IP アドレスが表示されていることを確認する

### 4.3. 機器のローカル IP アドレスを設定する

1. `詳細設定`タブを押下する
2. 左ペインの`LAN`を押下する
3. `IPアドレス`を押下する
4. `IPv4アドレス` > `LAN` > `設定`を押下する
5. `対象インターフェース`が`LAN`と表示されていることを確認する
6. 以下を指定する
    - プライマリーIPアドレス
      - `手動設定`: `192.168.1.1` / `255.255.255.0(24bit)`
        - `IPアドレスの変更に合わせて、その他の設定のIPアドレスを自動で変更する`: チェックあり
          - `設定に含まれるIPアドレスをすべて変更する`: チェックあり
    - セカンダリーIPアドレス
      - `アドレスを割り当てない`
7. `確認`を押下する
8. `設定の確定`を押下する
9. `PowerShell`にて以下コマンドを実行することで、作業端末の IP アドレスを取得し直す

    ```pwsh
    ipconfig /flushdns
    ipconfig /release
    ipconfig /renew
    ```

10. 設定画面を再度ブラウザで開く
    - アドレス: <https://192.168.1.1/>
    - ログイン情報: ユーザ・パスワードともに空欄
11. `詳細設定`タブを押下する
12. 左ペインの`LAN`を押下する
13. `IPアドレス`を押下する
14. `IPv4アドレス` > `LAN` > `IPv4アドレス` > `LAN`のプライマリー IP アドレスが`192.168.1.1/24`、セカンダリー IP アドレスが`割り当てられていません`と表示されていることを確認する

### 4.4. 使用しないポートを閉塞する

1. `詳細設定`タブを押下する
2. 左ペインの`LAN`を押下する
3. `ポート`を押下する
4. `ポートの設定` > `LAN` > `設定`を押下する
5. `対象インターフェース`が`LAN`と表示されていることを確認する
6. 以下を指定する
    - ポートの設定
      - 個別に設定する
        - 1: オートネゴシエーション
        - 2: オートネゴシエーション
        - 3: シャットダウン
        - 4: シャットダウン
7. `確認`を押下する
8. `設定の確定`を押下する
9. `ポートの設定` > `LAN`に、指定した`ポート番号`と`設定内容`の組み合わせが表示されていることを確認する

### 4.5. タグVLANを設定する

各タグVLANごとに、それぞれ以下操作を繰り返します。

| インターフェース | VID  | 名前    | IPアドレス                               |
|------------------|------|---------|------------------------------------------|
| `LAN1`/`1`       | `10` | `Home`  | `192.168.10.1` / `255.255.255.0 (24bit)` |
| `LAN1`/`2`       | `20` | `Labo`  | `192.168.20.1` / `255.255.255.0 (24bit)` |
| `LAN1`/`3`       | `30` | `Work`  | `192.168.30.1` / `255.255.255.0 (24bit)` |
| `LAN1`/`4`       | `40` | `IoT`   | `192.168.40.1` / `255.255.255.0 (24bit)` |

1. `詳細設定`タブを押下する
2. 左ペインの`VLAN`を押下する
3. `タグVLAN`を押下する
4. `タグVLANの設定` > `新規`を押下する
5. 上記表にしたがって、項目を指定する
6. `確認`を押下する
7. `設定の確定`を押下する
8. `タグVLANの設定`に、作成したVLANが表示されていることを確認する

### 4.6. VLAN間ルーティングを設定する

1. `詳細設定`タブを押下する
2. 左ペインの`VLAN`を押下する
3. `VLAN間フィルター`を押下する
4. `VLAN 間フィルターの設定` > `LAN1` > `設定`を押下する
5. 以下を指定する
    - インターフェース間の通信可否の設定: `カスタム設定`
      - LAN1 のすべてのインターフェースとの通信を許可するインターフェースを設定する: チェックなし
      - 相互に通信を許可する VLAN インターフェースのグループを設定する: チェックあり
        - グループ1
          - `LAN1`
          - `LAN1/1`
        - グループ2
          - `LAN1/1`
          - `LAN1/2`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `VLAN 間フィルターの設定`に、設定したフィルターが表示されていることを確認する

### 4.7. VLAN間同士のIPフィルターを設定する

1. `詳細設定`タブを押下する
2. 左ペインの`セキュリティー`を押下する
3. `IPフィルター`を押下する
4. `インターフェースの一覧` > `IPv4`を押下する
5. `LAN1/2` > `確認`を押下する
6. `静的フィルター` > `編集`を押下する
7. `適用リストの設定` > `静的フィルター` > `新規`を押下する
8. 以下を指定する
      - 番号: `1001100`
      - タイプ: `restrict(ログなし)`
      - プロトコル: 手動入力: `*`
      - 送信元アドレス: `すべてのアドレス`
      - 宛先アドレス: `IPv4 アドレス、FQDN、「map-e」、または「hb46pp」を指定`: `192.168.10.0/24`
      - 送信元ポート番号: `すべてのポート番号`
      - 宛先ポート番号: `すべてのポート番号`
9. `確認`を押下する
10. `設定の確定`を押下する
11. `適用リストの設定` > `静的フィルター` > `1001100`にチェックを入れる
12. `先頭に追加`を押下する
13. `適用リストの設定` > `静的フィルター` > `500000`にチェックを入れる
14. `末尾に追加`を押下する
15. `確認`を押下する
16. `設定の確定`を押下する
17. `適用リストの設定` > `適用フィルター`に`1001100`と`500000`が表示されていることを確認する

### 4.8. DHCPサーバの払い出しIP範囲を設定する

#### 4.8.1. 追加したVLAN向けに設定する

各IP範囲ごとに、それぞれ以下操作を繰り返します。

| 識別番号 | IPアドレスの範囲                                               | ゲートウェイ | 標準リース時間          | 最大リース時間          |
|----------|----------------------------------------------------------------|--------------|-------------------------|-------------------------|
| 10       | `192.168.10.200` ～ `192.168.10.254` / `255.255.255.0 (24bit)` | (空欄)       | `指定する`: `12時間0分` | `指定する`: `12時間0分` |
| 30       | `192.168.30.2` ～ `192.168.30.254` / `255.255.255.0 (24bit)`   | (空欄)       | `指定する`: `12時間0分` | `指定する`: `12時間0分` |
| 40       | `192.168.40.2` ～ `192.168.40.254` / `255.255.255.0 (24bit)`   | (空欄)       | `指定する`: `12時間0分` | `指定する`: `12時間0分` |

1. `詳細設定`タブを押下する
2. 左ペインの`DHCPサーバー`を押下する
3. `DHCPサーバーの動作モード`で`DHCPサーバー機能が有効になっています。`と表示されていることを確認する
4. `DHCPによるアドレス割り当ての一覧` > `新規`を押下する
5. 上記表にしたがって、項目を指定する
6. `確認`を押下する
7. `設定の確定`を押下する
8. `DHCPによるアドレス割り当ての一覧`に、指定したIP範囲が表示されていることを確認する

#### 4.8.2. 既存のVLAN1向けに設定する

1. `詳細設定`タブを押下する
2. 左ペインの`DHCPサーバー`を押下する
3. `DHCPによるアドレス割り当ての一覧` > `1` > `設定`を押下する
4. `識別番号`が`1`と表示されていることを確認する
5. 以下を指定する
    - IPアドレスの範囲: `192.168.1.2` ～ `192.168.1.254`
    - ゲートウェイ: (空欄)
    - 標準リース時間: `指定する`: `12時間0分`
    - 最大リース時間: `指定する`: `12時間0分`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `DHCPによるアドレス割り当ての一覧`に、指定したIP範囲が表示されていることを確認する

### 4.9. 日付と時刻を設定する

1. `管理`タブを押下する
2. 左ペインの`本体の設定`を押下する
3. `日付と時刻の設定` > `設定`を押下する
4. 以下を指定する
    - 手動設定: チェックなし
    - 日時の同期:
      - 同期時刻: `毎週月曜日` `05:00:00`
      - 問い合わせ先NTPサーバー: `ntp.nict.jp`
5. `設定の確定`を押下する
6. `日付と時刻の設定`に、指定した設定が表示されていることを確認する

### 4.10. ブザー設定を無効化する

1. `管理`タブを押下する
2. 左ペインの`本体の設定`を押下する
3. `ブザー設定` > `設定`を押下する
4. 以下を指定する
    - ブザー通知(アラーム音を鳴らす): `無効`
    - 通知の条件: すべてチェックなし
5. `設定の確定`を押下する
6. `ブザー設定`に、指定した設定が表示されていることを確認する

### 4.11. アクセス等に必要なユーザとパスワードを設定する

#### 4.11.1. 管理パスワードを設定する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `ユーザの設定`を押下する
4. `管理パスワードの設定` > `設定`を押下する
5. 以下を指定する
      - 新しいパスワード: （任意のパスワード）
      - 新しいパスワード（確認）: （任意のパスワード）
      - パスワードの暗号化: 暗号化する
6. `確認`を押下する
7. `設定の確定`を押下する
8. ログイン情報を求められるので、以下を指定してログインすることで、管理パスワードが設定されていることを確認する
    - ユーザ名: (空欄)
    - パスワード: (管理パスワード)

#### 4.11.2. 作業用ユーザを追加する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `ユーザの設定`を押下する
4. `ユーザーアカウントの設定` > `新規`を押下する
5. 以下を指定する
      - ユーザー名: (任意のユーザ名)
      - 新しいパスワード: （任意のパスワード）
      - 新しいパスワード（確認）: （任意のパスワード）
      - 管理ユーザーへの昇格: `許可する`
      - 接続方法の許可: `すべて許可する`
      - 接続を許可する端末の制限: `すべて許可する`
      - 自動ログアウトまでの時間: `20分`
      - Web GUI 画面の閲覧の許可: `すべて許可する`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `ユーザーアカウントの設定`に、追加したユーザ設定が表示されていることを確認する
9. 右上の`ユーザ名なし`を押下する
10. `ログアウト`を押下する
11. 設定画面を再度ブラウザで開く
    - アドレス: <https://192.168.1.1/>
    - ログイン情報
      - ユーザ名: (先ほど追加したユーザのユーザ名)
      - パスワード: (管理パスワード)

### 4.12. `ユーザー名なし`を実質的に無効化する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `ユーザの設定`を押下する
4. `ユーザーアカウントの設定` > `ユーザー名なし` > `設定`を押下する
5. `ユーザー名`に`ユーザー名なし`と表示されていることを確認する
6. 以下を指定する
      - 新しいパスワード: （任意のパスワード）
      - 新しいパスワード（確認）: （任意のパスワード）
      - 管理ユーザーへの昇格: `許可しない`
      - 接続方法の許可: `すべて許可しない`
      - 接続を許可する端末の制限: `すべて許可する`
      - 自動ログアウトまでの時間: `2分`
      - Web GUI 画面の閲覧の許可: `指定した画面の閲覧を許可する`
        - 以下にチェック
          - ダッシュボード画面
7. `確認`を押下する
8. `設定の確定`を押下する
9. `ユーザーアカウントの設定`に、設定したユーザ設定が表示されていることを確認する

### 4.13. SSH接続を設定する

#### 4.13.1. SSHサーバーを有効化する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `各種サーバーの設定`を押下する
4. `SSH/SFTP を使用したアクセス` > `設定`を押下する
5. 以下を指定する
    - SSH サーバーの使用: `使用する`
    - SSH サーバーへのアクセス許可: `指定したインターフェース/IPアドレスのみ許可する`
      - 以下にチェック
        - `LAN`
        - `LAN1/1`
        - `IPアドレス`
          - `192.168.20.3`
    - 暗号アルゴリズム: 以下にチェック
      - `aes128-ctr`
      - `aes192-ctr`
      - `aes256-ctr`
    - SFTP サーバーへのアクセス許可: `指定したインターフェース/IPアドレスのみ許可する`
      - 以下にチェック
        - `LAN`
        - `LAN1/1`
        - `IPアドレス`
          - `192.168.20.3`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `SSH/SFTP を使用したアクセス`に、指定した設定が表示されていることを確認する

#### 4.13.2. 公開鍵認証に用いる公開鍵の情報を転送する

1. `RTX830`に向かってtelnetプロトコルを用いて接続する

    ```shell
    > telnet 192.168.1.1
    Username: (作業用ユーザのユーザ名)
    Password: (作業用ユーザのパスワード)
    RTX830 Rev.**.**.** (Fri Jul  5 10:40:25 2024)
    Copyright (c) 1994-2024 Yamaha Corporation. All Rights Reserved.
    To display the software copyright statement, use 'show copyright' command.
    ac:44:f2:**:**:**, ac:44:f2:**:**:**
    Memory 256Mbytes, 2LAN
    > administrator
    Password: (管理パスワード)
    # import sshd authorized-keys (作業用ユーザのユーザ名)
    インポート先のファイル:
    /ssh/authorized_keys/(作業用ユーザのユーザ名)

    公開鍵を1つ入力してください: (公開鍵を貼り付け)

    公開鍵をインポートしますか? (Y/N)Y
    インポートしました。

    (貼り付けた公開鍵)
    # exit
    > exit
    ホストとの接続が切断されました。
    >
    ```

2. SSH接続できることを確認する

    ```shell
    > ssh -i (秘密鍵へのパス) (作業用ユーザのユーザ名)@192.168.1.1
    The authenticity of host '192.168.1.1 (192.168.1.1)' can't be established.
    RSA key fingerprint is (鍵のフィンガープリント).
    This key is not known by any other names.
    Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
    Warning: Permanently added '192.168.1.1' (RSA) to the list of known hosts.


    RTX830 Rev.**.**.** (Fri Jul  5 10:40:25 2024)
    Copyright (c) 1994-2024 Yamaha Corporation. All Rights Reserved.
    To display the software copyright statement, use 'show copyright' command.
    ac:44:f2:**:**:**:**, ac:44:f2:**:**:**:**
    Memory 256Mbytes, 2LAN
    > exit
    Connection to 192.168.1.1 closed.
    >
    ```

#### 4.13.3. コンソールの文字コードを`UTF-8`に設定する

1. SSH接続する

    ```shell
    > ssh -i (秘密鍵へのパス) (作業用ユーザのユーザ名)@192.168.1.1
    RTX830 Rev.**.**.** (Fri Jul  5 10:40:25 2024)
    Copyright (c) 1994-2024 Yamaha Corporation. All Rights Reserved.
    To display the software copyright statement, use 'show copyright' command.
    ac:44:f2:**:**:**, ac:44:f2:**:**:**
    Memory 256Mbytes, 2LAN
    >
    ```

2. コンソールの文字コードを`UTF-8`に設定する

    ```shell
    > administrator
    Password: (管理パスワード)
    # console character ja.utf8
    ```

3. 設定できていることを確認する

    ```shell
    # show config
    ...
    console character ja.utf8
    ...
    >
    ```

4. 設定を保存して、SSH接続を切断する

    ```shell
    # exit
    新しい設定を保存しますか? (Y/N)Y
    セーブ中... CONFIG0 終了
    > exit
    Connection to 192.168.1.1 closed.
    >
    ```

#### 4.13.4. telnetサーバを無効化する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `各種サーバーの設定`を押下する
4. `TELNET を使用したアクセス` > `設定`を押下する
5. 以下を指定する
    - TELNET サーバーの使用: `使用しない`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `TELNET を使用したアクセス`に、指定した設定が表示されていることを確認する

#### 4.13.5. telnetサーバへのアクセスを拒否する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `ユーザの設定`を押下する
4. `ユーザーアカウントの設定` > (作業用ユーザのユーザ名) > `設定`を押下する
5. `接続方法の許可`を以下のように指定する
   - 指定した接続方法を許可する
     - シリアルコンソール
     - SSH
     - SFTP
     - HTTP
6. `確認`を押下する
7. `設定の確定`を押下する
8. `ユーザーアカウントの設定`に、設定したユーザ設定が表示されていることを確認する

### 4.14. Web GUIへのアクセスを制限する

1. `管理`タブを押下する
2. 左ペインの`アクセス管理`を押下する
3. `各種サーバーの設定`を押下する
4. `Web GUI へのアクセス` > `設定`を押下する
5. 以下を指定する
    - GUI へのアクセス許可: `指定したインターフェース/IPアドレスのみ許可する`
      - 以下にチェック
        - `LAN`
        - `LAN1/1`
        - `IPアドレス`
          - `192.168.20.3`
6. `確認`を押下する
7. `設定の確定`を押下する
8. `Web GUI へのアクセス`に、設定した設定が表示されていることを確認する

### 4.15. L2MSを有効化する

1. `LANマップ`タブを押下する
2. `設定`を押下する
3. 以下を指定する
    **基本設定**
    - L2MSを有効にするインターフェース
      - 以下にチェック
        - LAN
4. `設定の確定`を押下する
5. LANマップが表示されていることを確認する

## 5. 完了条件

- `RTX830`の設定が完了していること
- 作業端末からインターネットに通信ができること
